name: Deploy to EC2

on:
  push:
    branches: [ master ]
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test SSH Connection
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT }}
        script: |
          echo "ğŸ” Testing SSH connection..."
          echo "Current user: $(whoami)"
          echo "Current directory: $(pwd)"
          echo "Home directory: $HOME"
          echo "SSH connection successful!"
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT }}
        script: |
          set -e  # Exit on any error
          echo "ğŸš€ Starting automatic deployment from GitHub..."
          
          # Create app directory if it doesn't exist
          mkdir -p ~/app
          cd ~/app
          echo "ğŸ“ Working directory: $(pwd)"
          
          # Check Node.js and npm versions
          echo "ğŸ” Checking Node.js environment..."
          if ! command -v node &> /dev/null; then
            echo "âŒ Node.js is not installed. Installing Node.js 18..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          
          # Check if git repository exists
          if [ -d "multi-analysis-starter" ]; then
            echo "ğŸ“ Found existing repository, pulling latest changes..."
            cd multi-analysis-starter
            
            # Check current branch
            echo "Current branch: $(git branch --show-current)"
            
            # Stash any local changes (if any)
            git stash || echo "No changes to stash"
            
            # Pull latest changes from master branch
            git pull origin master
            
            # If there were stashed changes, pop them back
            git stash pop 2>/dev/null || echo "No stashed changes to pop"
          else
            echo "ğŸ“ No existing repository found, cloning fresh..."
            rm -rf multi-analysis-starter
            git clone https://github.com/${{ github.repository }}.git multi-analysis-starter
            cd multi-analysis-starter
          fi
          
          # Clear npm cache and node_modules to ensure clean install
          echo "ğŸ§¹ Cleaning npm cache and node_modules..."
          npm cache clean --force || echo "npm cache clean failed (continuing)"
          rm -rf node_modules || echo "No root node_modules to remove"
          rm -rf packages/*/node_modules || echo "No package node_modules to remove"
          
          echo "ğŸ“¦ Installing dependencies..."
          echo "Installing root dependencies..."
          npm install || {
            echo "âŒ Failed to install root dependencies"
            echo "npm error log:"
            npm ls --depth=0 || echo "npm ls failed"
            exit 1
          }
          
          echo "Installing shared package dependencies..."
          npm install --prefix packages/shared || {
            echo "âŒ Failed to install shared package dependencies"
            exit 1
          }
          
          echo "Installing API package dependencies..."
          npm install --prefix packages/api || {
            echo "âŒ Failed to install API package dependencies"
            exit 1
          }
          
          echo "Installing web package dependencies..."
          npm install --prefix packages/web || {
            echo "âŒ Failed to install web package dependencies"
            exit 1
          }
          
          echo "Installing worker package dependencies..."
          npm install --prefix packages/worker || {
            echo "âŒ Failed to install worker package dependencies"
            exit 1
          }
          
          echo "ğŸ”¨ Building application..."
          echo "Building shared package..."
          npm run build --prefix packages/shared || {
            echo "âŒ Failed to build shared package"
            exit 1
          }
          
          echo "Building API package..."
          npm run build --prefix packages/api || {
            echo "âŒ Failed to build API package"
            exit 1
          }
          
          echo "Building web package..."
          npm run build --prefix packages/web || {
            echo "âŒ Failed to build web package"
            exit 1
          }
          

          
          echo "ğŸ”„ Restarting application..."
          
          # Check which deployment method is being used
          if [ -f "docker-compose.yml" ] || [ -f "docker-compose.prod.yml" ]; then
            echo "ğŸ³ Restarting Docker containers..."
            if [ -f "docker-compose.prod.yml" ]; then
              docker-compose -f docker-compose.prod.yml down || echo "Docker compose down failed (might not be running)"
              docker-compose -f docker-compose.prod.yml up -d --build
            else
              docker-compose down || echo "Docker compose down failed (might not be running)"
              docker-compose up -d --build
            fi
          elif command -v pm2 &> /dev/null; then
            echo "âš¡ Restarting PM2 processes..."
            pm2 restart all || echo "PM2 restart failed (might not be running)"
          elif systemctl is-active --quiet multi-analysis; then
            echo "ğŸ”§ Restarting systemd service..."
            sudo systemctl restart multi-analysis
          else
            echo "âš ï¸  No known process manager found. Please restart manually."
            echo "Available process managers:"
            command -v docker-compose && echo "- Docker Compose available"
            command -v pm2 && echo "- PM2 available"
            systemctl list-units --type=service | grep multi-analysis && echo "- systemd service available"
          fi
          
          echo "âœ… Automatic deployment completed successfully!"
          echo "ğŸŒ Frontend: http://${{ secrets.EC2_HOST }}:3000"
          echo "ğŸ”Œ API: http://${{ secrets.EC2_HOST }}:3001"
          
    - name: Health Check
      run: |
        echo "ğŸ” Performing health check..."
        echo "Waiting 30 seconds for services to start..."
        sleep 30
        
        echo "Testing frontend connection..."
        # Check if frontend is responding
        if curl -f -s --connect-timeout 10 http://${{ secrets.EC2_HOST }}:3000 > /dev/null; then
          echo "âœ… Frontend is responding"
        else
          echo "âŒ Frontend is not responding"
          echo "This might be normal if the app isn't running yet or uses a different port"
        fi
        
        echo "Testing API connection..."
        # Check if API is responding
        if curl -f -s --connect-timeout 10 http://${{ secrets.EC2_HOST }}:3001 > /dev/null; then
          echo "âœ… API is responding"
        else
          echo "âŒ API is not responding"
          echo "This might be normal if the app isn't running yet or uses a different port"
        fi
        
        echo "ğŸ‰ Health check completed!"
        echo "Note: Health check failures don't necessarily mean deployment failed"
