name: Deploy to EC2

on:
  push:
    branches: [ master ]
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test SSH Connection
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT }}
        script: |
          echo "üîç Testing SSH connection..."
          echo "Current user: $(whoami)"
          echo "Current directory: $(pwd)"
          echo "Home directory: $HOME"
          echo "SSH connection successful!"
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT }}
        script: |
          set -e  # Exit on any error
          echo "üöÄ Starting automatic deployment from GitHub..."
          
          # Create app directory if it doesn't exist
          mkdir -p ~/app
          cd ~/app
          echo "üìÅ Working directory: $(pwd)"
          
          # Setup swap space to handle memory constraints
          echo "üíæ Setting up swap space for memory management..."
          if ! swapon --show | grep -q "/swapfile"; then
            echo "Creating swap file..."
            sudo fallocate -l 2G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
          fi
          echo "Swap space: $(free -h | grep Swap)"
          
          # Ensure Node.js 22 is installed
          echo "üîç Checking Node.js environment..."
          CURRENT_NODE_VERSION=$(node --version 2>/dev/null || echo "not_installed")
          echo "Current Node.js version: $CURRENT_NODE_VERSION"
          
          if [[ "$CURRENT_NODE_VERSION" != "v22"* ]]; then
            echo "üîÑ Updating to Node.js 22..."
            
            # Detect Linux distribution
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              OS=$NAME
              VER=$VERSION_ID
              echo "Detected OS: $OS $VER"
            else
              echo "Could not detect OS, assuming Amazon Linux"
              OS="Amazon Linux"
            fi
            
            # Remove old Node.js if present
            if command -v node &> /dev/null; then
              echo "Removing old Node.js installation..."
              if command -v yum &> /dev/null; then
                sudo yum remove -y nodejs npm 2>/dev/null || echo "No old Node.js to remove via yum"
              elif command -v apt &> /dev/null; then
                sudo apt remove -y nodejs npm 2>/dev/null || echo "No old Node.js to remove via apt"
              fi
            fi
            
            # Install Node.js 22 based on distribution
            echo "Installing Node.js 22..."
            if [[ "$OS" == *"Amazon Linux"* ]] || [[ "$OS" == *"Red Hat"* ]] || [[ "$OS" == *"CentOS"* ]]; then
              echo "Using NodeSource for RHEL/CentOS/Amazon Linux..."
              curl -fsSL https://rpm.nodesource.com/setup_22.x | sudo bash -
              sudo yum install -y nodejs
            elif [[ "$OS" == *"Ubuntu"* ]] || [[ "$OS" == *"Debian"* ]]; then
              echo "Using NodeSource for Ubuntu/Debian..."
              curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
              sudo apt-get install -y nodejs
            else
              echo "Unknown distribution, trying NodeSource RHEL method..."
              curl -fsSL https://rpm.nodesource.com/setup_22.x | sudo bash -
              sudo yum install -y nodejs 2>/dev/null || sudo apt-get install -y nodejs
            fi
            
            # Verify installation
            echo "Node.js version: $(node --version)"
            echo "npm version: $(npm --version)"
            
            if [[ "$(node --version)" != "v22"* ]]; then
              echo "‚ùå Failed to install Node.js 22"
              echo "Trying alternative installation method..."
              
              # Fallback: Install Node.js via nvm
              echo "Installing Node.js via nvm..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
              nvm install 22
              nvm use 22
              nvm alias default 22
              
              # Verify nvm installation
              echo "Node.js version (nvm): $(node --version)"
              if [[ "$(node --version)" != "v22"* ]]; then
                echo "‚ùå All Node.js 22 installation methods failed"
                exit 1
              fi
            fi
          else
            echo "‚úÖ Node.js 22 already installed"
          fi
          
          # Update npm to latest version
          echo "üîÑ Updating npm to latest version..."
          sudo npm install -g npm@latest || {
            echo "Failed to update npm globally, trying alternative method..."
            # Try updating npm without sudo if sudo fails
            npm install -g npm@latest || echo "npm update failed, continuing with current version"
          }
          echo "Updated npm version: $(npm --version)"
          
          # Check if git repository exists
          if [ -d "multi-analysis-starter" ]; then
            echo "üìÅ Found existing repository, pulling latest changes..."
            cd multi-analysis-starter
            
            # Check current branch
            echo "Current branch: $(git branch --show-current)"
            
            # Stash any local changes (if any)
            git stash || echo "No changes to stash"
            
            # Pull latest changes from master branch
            git pull origin master
            
            # If there were stashed changes, pop them back
            git stash pop 2>/dev/null || echo "No stashed changes to pop"
          else
            echo "üìÅ No existing repository found, cloning fresh..."
            rm -rf multi-analysis-starter
            git clone https://github.com/${{ github.repository }}.git multi-analysis-starter
            cd multi-analysis-starter
          fi
          
          # Set Node.js memory limits
          export NODE_OPTIONS="--max-old-space-size=4096"
          echo "üîß Set NODE_OPTIONS: $NODE_OPTIONS"
          
          # Clear npm cache and node_modules to ensure clean install
          echo "üßπ Cleaning npm cache and node_modules..."
          npm cache clean --force || echo "npm cache clean failed (continuing)"
          rm -rf node_modules || echo "No root node_modules to remove"
          rm -rf packages/*/node_modules || echo "No package node_modules to remove"
          rm -rf packages/*/package-lock.json || echo "No package-lock files to remove"
          
          echo "üì¶ Installing dependencies..."
          echo "Installing root dependencies..."
          npm install --no-optional || {
            echo "‚ùå Failed to install root dependencies"
            echo "npm error log:"
            npm ls --depth=0 || echo "npm ls failed"
            exit 1
          }
          
          echo "Installing shared package dependencies..."
          cd packages/shared
          npm install --no-optional || {
            echo "‚ùå Failed to install shared package dependencies"
            exit 1
          }
          cd ../..
          
          echo "Installing API package dependencies..."
          cd packages/api
          npm install --no-optional || {
            echo "‚ùå Failed to install API package dependencies"
            exit 1
          }
          cd ../..
          
          echo "Installing worker package dependencies..."
          cd packages/worker
          npm install --no-optional || {
            echo "‚ùå Failed to install worker package dependencies"
            exit 1
          }
          cd ../..
          
          echo "Installing web package dependencies (with memory optimization)..."
          # Install web dependencies with memory optimization
          cd packages/web
          npm install --no-optional --production=false || {
            echo "‚ùå Failed to install web package dependencies"
            echo "Trying with reduced memory usage..."
            npm install --no-optional --production=false --maxsockets=1 || {
              echo "‚ùå Web package installation failed even with reduced memory"
              exit 1
            }
          }
          cd ../..
          
          # Copy data files to API package for local data serving
          echo "üìÅ Copying data files for API..."
          if [ -d "data" ]; then
            # Copy to API package
            mkdir -p packages/api/data
            cp -r data/* packages/api/data/ || echo "Failed to copy data files to API package"
            
            # Copy to root for fallback
            mkdir -p data
            cp -r data/* data/ || echo "Failed to copy data files to root"
            
            echo "‚úÖ Data files copied to packages/api/data/ and root data/"
          else
            echo "‚ö†Ô∏è  No data directory found in repository"
          fi
          
          echo "üî® Building application..."
          echo "Building shared package..."
          cd packages/shared
          npm run build || {
            echo "‚ùå Failed to build shared package"
            exit 1
          }
          cd ../..
          
          echo "Building API package..."
          cd packages/api
          npm run build || {
            echo "‚ùå Failed to build API package"
            exit 1
          }
          cd ../..
          
          echo "Building web package..."
          cd packages/web
          npm run build || {
            echo "‚ùå Failed to build web package"
            exit 1
          }
          cd ../..
          
          echo "üîÑ Restarting application..."
          
          # Check what's actually running and what's available
          echo "üîç Checking current deployment status..."
          
          # Check if any processes are running on expected ports
          if netstat -tlnp 2>/dev/null | grep -q ":3000\|:3001"; then
            echo "Found processes running on ports 3000/3001"
            netstat -tlnp 2>/dev/null | grep ":3000\|:3001" || echo "No specific process info available"
          else
            echo "No processes found on ports 3000/3001"
          fi
          
          # Check what process managers are available
          echo "Available process managers:"
          command -v docker-compose && echo "- Docker Compose available"
          command -v docker && echo "- Docker available"
          command -v pm2 && echo "- PM2 available"
          systemctl list-units --type=service | grep -i multi-analysis && echo "- systemd service available"
          
          # Check if there are any running containers
          if command -v docker &> /dev/null; then
            echo "Running Docker containers:"
            docker ps 2>/dev/null || echo "No Docker containers running or Docker not accessible"
          fi
          
          # Check if there are any PM2 processes
          if command -v pm2 &> /dev/null; then
            echo "PM2 processes:"
            pm2 list 2>/dev/null || echo "No PM2 processes running"
          fi
          
          # Try to restart based on what's actually available
          if [ -f "docker-compose.yml" ] && command -v docker-compose &> /dev/null; then
            echo "üê≥ Restarting Docker containers..."
            docker-compose down || echo "Docker compose down failed (might not be running)"
            docker-compose up -d --build
          elif [ -f "docker-compose.prod.yml" ] && command -v docker-compose &> /dev/null; then
            echo "üê≥ Restarting Docker containers (prod)..."
            docker-compose -f docker-compose.prod.yml down || echo "Docker compose down failed (might not be running)"
            docker-compose -f docker-compose.prod.yml up -d --build
          elif command -v pm2 &> /dev/null; then
            echo "‚ö° Restarting PM2 processes..."
            pm2 restart all || echo "PM2 restart failed (might not be running)"
          elif systemctl is-active --quiet multi-analysis 2>/dev/null; then
            echo "üîß Restarting systemd service..."
            sudo systemctl restart multi-analysis
          else
            echo "‚ö†Ô∏è  No known process manager found or configured."
            echo "üîÑ Attempting to set up PM2 as fallback..."
            
            # Try to install and set up PM2
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              npm install -g pm2 || echo "Failed to install PM2 globally"
            fi
            
            if command -v pm2 &> /dev/null; then
              echo "Setting up PM2 processes..."
              # Stop any existing PM2 processes
              pm2 delete all 2>/dev/null || echo "No existing PM2 processes to delete"
              
              # Start API
              cd packages/api
              pm2 start npm --name "api" -- start --cwd . || echo "Failed to start API with PM2"
              cd ../..
              
              # Start web
              cd packages/web
              pm2 start npm --name "web" -- start --cwd . || echo "Failed to start web with PM2"
              cd ../..
              
              echo "PM2 processes started:"
              pm2 list
            else
              echo "üìã Manual restart required. You may need to:"
              echo "   1. Install Docker Compose: sudo yum install -y docker-compose"
              echo "   2. Install PM2: npm install -g pm2"
              echo "   3. Or start the application manually"
              echo ""
              echo "üîç Current system status:"
              echo "Memory: $(free -h | grep Mem)"
              echo "Disk: $(df -h / | tail -1)"
              echo "Node.js: $(node --version)"
              echo "npm: $(npm --version)"
            fi
          fi
          
          echo "‚úÖ Automatic deployment completed successfully!"
          echo "üåê Frontend: http://${{ secrets.EC2_HOST }}:3000"
          echo "üîå API: http://${{ secrets.EC2_HOST }}:3001"
          
    - name: Health Check
      run: |
        echo "üîç Performing health check..."
        echo "Waiting 30 seconds for services to start..."
        sleep 30
        
        echo "Testing frontend connection..."
        # Check if frontend is responding
        if curl -f -s --connect-timeout 10 http://${{ secrets.EC2_HOST }}:3000 > /dev/null; then
          echo "‚úÖ Frontend is responding"
        else
          echo "‚ùå Frontend is not responding"
          echo "This might be normal if the app isn't running yet or uses a different port"
        fi
        
        echo "Testing API connection..."
        # Check if API is responding
        if curl -f -s --connect-timeout 10 http://${{ secrets.EC2_HOST }}:3001 > /dev/null; then
          echo "‚úÖ API is responding"
        else
          echo "‚ùå API is not responding"
          echo "This might be normal if the app isn't running yet or uses a different port"
        fi
        
        echo "üéâ Health check completed!"
        echo "Note: Health check failures don't necessarily mean deployment failed"
