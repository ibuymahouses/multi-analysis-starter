# Deploy to EC2
# Test deployment with timeout fixes
name: Deploy to EC2

on:
  push:
    branches: [ master ]
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Phase 1 - Environment Setup
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT }}
        command_timeout: "5m"
        script: |
          echo "üîß PHASE 1: Environment Setup"
          echo "============================"
          
          # Setup basic environment
          mkdir -p ~/app
          cd ~/app
          
          # Setup swap space (if needed)
          if ! swapon --show | grep -q "/swapfile"; then
            sudo fallocate -l 2G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
          fi
          
          # Ensure Node.js 22 is available
          if [[ "$(node --version 2>/dev/null)" != "v22"* ]]; then
            curl -fsSL https://rpm.nodesource.com/setup_22.x | sudo bash -
            sudo yum install -y nodejs
          fi
          
          echo "‚úÖ Environment setup complete"
          echo "Node.js: $(node --version)"
          echo "npm: $(npm --version)"
          echo "Memory: $(free -h | grep Mem)"
          
    - name: Phase 2 - Code Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT }}
        command_timeout: "8m"
        script: |
          echo "üì¶ PHASE 2: Code Deployment"
          echo "==========================="
          
          cd ~/app
          
          # Clean deployment
          rm -rf multi-analysis-starter
          git clone https://github.com/${{ github.repository }}.git multi-analysis-starter
          cd multi-analysis-starter
          
          # Set memory limits
          export NODE_OPTIONS="--max-old-space-size=4096"
          
          # Install dependencies (with error handling)
          echo "Installing root dependencies..."
          npm install --no-optional || {
            echo "‚ö†Ô∏è Root dependencies failed, continuing..."
          }
          
          # Install package dependencies (independently)
          for package in shared api worker web; do
            echo "Installing $package dependencies..."
            cd packages/$package
            npm install --no-optional || {
              echo "‚ö†Ô∏è $package dependencies failed, continuing..."
            }
            cd ../..
          done
          
          # Copy data files
          echo "Setting up data files..."
          mkdir -p packages/api/data
          cp -r data/* packages/api/data/ || {
            echo "‚ö†Ô∏è Data file copy failed, continuing..."
          }
          
          echo "‚úÖ Code deployment complete"
          
    - name: Phase 3 - Build Process
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT }}
        command_timeout: "5m"
        script: |
          echo "üî® PHASE 3: Build Process"
          echo "========================="
          
          cd ~/app/multi-analysis-starter
          export NODE_OPTIONS="--max-old-space-size=4096"
          
          # Build packages (independently)
          echo "Building shared package..."
          cd packages/shared
          npm run build || {
            echo "‚ö†Ô∏è Shared build failed, continuing..."
          }
          cd ../..
          
          echo "Building API package..."
          cd packages/api
          npm run build || {
            echo "‚ö†Ô∏è API build failed, continuing..."
          }
          cd ../..
          
          echo "Building web package..."
          cd packages/web
          npm run build || {
            echo "‚ö†Ô∏è Web build failed, continuing..."
          }
          cd ../..
          
          echo "‚úÖ Build process complete"
          
    - name: Phase 4 - Process Management
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT }}
        command_timeout: "5m"
        timeout: "5m"
        proxy_timeout: "5m"
        script_stop: false
        script: |
          echo "‚ö° PHASE 4: Smart Process Management"
          echo "==================================="
          echo "Start time: $(date)"
          echo "User: $(whoami)"
          echo "PWD: $(pwd)"
          echo "Memory: $(free -h | grep Mem)"
          echo ""
          
          cd ~/app/multi-analysis-starter
          echo "Changed to app directory: $(pwd)"
          
          echo "Checking if directories exist:"
          ls -la packages/
          echo ""
          
          # Check what's currently running
          echo "Current Node.js processes:"
          ps aux | grep node | grep -v grep || echo "No Node.js processes"
          echo ""
          
          # Check port availability
          echo "Checking port availability..."
          API_PORT=3001
          WEB_PORT=3000
          
          if netstat -tlnp 2>/dev/null | grep -q ":3001 "; then
            echo "‚ö†Ô∏è Port 3001 is in use, trying 3002..."
            API_PORT=3002
          fi
          
          if netstat -tlnp 2>/dev/null | grep -q ":3000 "; then
            echo "‚ö†Ô∏è Port 3000 is in use, trying 3003..."
            WEB_PORT=3003
          fi
          
          echo "Using API port: $API_PORT"
          echo "Using web port: $WEB_PORT"
          echo ""
          
          # Start API with smart port selection
          echo "Starting API on port $API_PORT..."
          cd packages/api
          echo "API directory: $(pwd)"
          echo "API package.json exists: $([ -f package.json ] && echo 'YES' || echo 'NO')"
          
          # Start API with custom port
          PORT=$API_PORT nohup npm start > api.log 2>&1 &
          API_PID=$!
          echo "API started with PID: $API_PID on port $API_PORT at $(date)"
          
          # Verify API process started
          sleep 3
          if ps -p $API_PID > /dev/null; then
            echo "‚úÖ API process confirmed running (PID: $API_PID)"
          else
            echo "‚ùå API process failed to start"
            echo "API log contents:"
            tail -10 api.log
          fi
          cd ../..
          
          # Start web with smart port selection
          echo "Starting web on port $WEB_PORT..."
          cd packages/web
          echo "Web directory: $(pwd)"
          echo "Web package.json exists: $([ -f package.json ] && echo 'YES' || echo 'NO')"
          
          # Set environment variable with dynamic port
          export NEXT_PUBLIC_API_URL=http://localhost:$API_PORT
          echo "Set NEXT_PUBLIC_API_URL: $NEXT_PUBLIC_API_URL"
          
          # Start web with custom port
          PORT=$WEB_PORT nohup npm start > web.log 2>&1 &
          WEB_PID=$!
          echo "Web started with PID: $WEB_PID on port $WEB_PORT at $(date)"
          
          # Verify web process started
          sleep 3
          if ps -p $WEB_PID > /dev/null; then
            echo "‚úÖ Web process confirmed running (PID: $WEB_PID)"
          else
            echo "‚ùå Web process failed to start"
            echo "Web log contents:"
            tail -10 web.log
          fi
          cd ../..
          
          # Final status check
          echo ""
          echo "Final status at $(date):"
          echo "API PID: $API_PID on port $API_PORT"
          echo "Web PID: $WEB_PID on port $WEB_PORT"
          echo "All Node.js processes:"
          ps aux | grep node | grep -v grep || echo "No Node.js processes"
          echo ""
          echo "Port usage:"
          netstat -tlnp 2>/dev/null | grep ":300[0-9]" || echo "No processes on ports 3000-3009"
          echo ""
          echo "‚úÖ Smart process management complete"
          
    - name: Phase 5 - Verification
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT }}
        command_timeout: "2m"
        script: |
          echo "üß™ PHASE 5: Verification"
          echo "========================"
          
          cd ~/app/multi-analysis-starter
          
          # Wait for processes to start
          echo "Waiting for processes to start..."
          sleep 10
          
          # Check processes
          echo "Checking processes..."
          ps aux | grep node | grep -v grep || echo "No Node.js processes found"
          
          # Check ports and determine which ones are being used
          echo "Checking ports..."
          netstat -tlnp 2>/dev/null | grep ":300[0-9]" || echo "No processes on expected ports"
          
          # Determine actual ports being used
          API_PORT=$(netstat -tlnp 2>/dev/null | grep "node.*dist/index.js" | awk '{print $4}' | cut -d: -f2 | head -1)
          WEB_PORT=$(netstat -tlnp 2>/dev/null | grep "next" | awk '{print $4}' | cut -d: -f2 | head -1)
          
          if [ -z "$API_PORT" ]; then
            API_PORT=3001
            echo "‚ö†Ô∏è Could not detect API port, using default: $API_PORT"
          else
            echo "‚úÖ Detected API port: $API_PORT"
          fi
          
          if [ -z "$WEB_PORT" ]; then
            WEB_PORT=3000
            echo "‚ö†Ô∏è Could not detect web port, using default: $WEB_PORT"
          else
            echo "‚úÖ Detected web port: $WEB_PORT"
          fi
          
          # Test endpoints
          echo "Testing endpoints..."
          curl -s --connect-timeout 5 http://localhost:$API_PORT/health > /dev/null && echo "‚úÖ API health endpoint working on port $API_PORT" || echo "‚ùå API health endpoint failed on port $API_PORT"
          curl -s --connect-timeout 5 http://localhost:$WEB_PORT > /dev/null && echo "‚úÖ Web endpoint working on port $WEB_PORT" || echo "‚ùå Web endpoint failed on port $WEB_PORT"
          
          echo "‚úÖ Verification complete"
          echo "üåê Frontend: http://${{ secrets.EC2_HOST }}:$WEB_PORT"
          echo "üîå API: http://${{ secrets.EC2_HOST }}:$API_PORT"
          
    - name: Final Health Check
      run: |
        echo "üîç Final health check..."
        sleep 30
        
        echo "Testing frontend..."
        if curl -f -s --connect-timeout 15 http://${{ secrets.EC2_HOST }}:3000 > /dev/null; then
          echo "‚úÖ Frontend responding"
        else
          echo "‚ùå Frontend not responding"
        fi
        
        echo "Testing API..."
        if curl -f -s --connect-timeout 15 http://${{ secrets.EC2_HOST }}:3001/health > /dev/null; then
          echo "‚úÖ API responding"
        else
          echo "‚ùå API not responding"
        fi
